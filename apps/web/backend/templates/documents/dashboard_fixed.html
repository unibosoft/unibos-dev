{% extends 'web_ui/base.html' %}

{% block title %}documents - ocr & integration{% endblock %}

{% block header_title %}unibos{% endblock %}
{% block module_name %}documents{% endblock %}

{% block content %}
<style>
    /* Checkbox styles */
    .document-checkbox {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 22px;
        height: 22px;
        z-index: 10;
        cursor: pointer;
        opacity: 0.9;
        accent-color: var(--orange);
    }
    
    .document-checkbox:checked {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .document-card.selected {
        border-color: var(--orange);
        background: rgba(255, 140, 0, 0.15);
        border-width: 2px;
    }
    
    .selection-mode .document-card:hover .document-checkbox {
        transform: scale(1.2);
        opacity: 1;
    }
    
    .bulk-actions {
        display: none;
        background: var(--bg-dark);
        border: 1px solid var(--orange);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
        align-items: center;
        gap: 10px;
    }
    
    .bulk-actions.show {
        display: flex;
    }
    
    .selection-info {
        color: var(--orange);
        font-weight: bold;
        margin-right: 20px;
    }
    
    .recycle-bin-link {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--bg-dark);
        border: 1px solid var(--orange);
        border-radius: 5px;
        padding: 8px 15px;
        color: var(--orange);
        text-decoration: none;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(255, 140, 0, 0.2);
    }
    
    .recycle-bin-link:hover {
        background: var(--orange);
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 140, 0, 0.3);
    }
    
    .recycle-bin-link .count {
        background: var(--red);
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
        font-weight: bold;
        font-size: 12px;
    }
    
    .documents-container {
        display: grid;
        gap: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
        padding: 15px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 24px;
        color: var(--orange);
        font-weight: bold;
    }
    
    .stat-label {
        color: var(--gray);
        font-size: 12px;
        text-transform: lowercase;
        margin-top: 5px;
    }
    
    /* Document grid with thumbnails */
    .document-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .document-card {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        text-align: center;
    }
    
    .document-card:hover {
        border-color: var(--orange);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 140, 0, 0.2);
    }
    
    .document-thumbnail {
        width: 100%;
        height: 120px;
        object-fit: cover;
        object-position: top center;  /* Fi≈üin √ºst kƒ±smƒ±nƒ± g√∂ster - maƒüaza ismi g√∂r√ºns√ºn */
        border-radius: 3px;
        margin-bottom: 8px;
        background: #000;
        border: 1px solid var(--dark-gray);
    }
    
    .document-placeholder {
        width: 100%;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
        border: 1px solid var(--dark-gray);
        border-radius: 3px;
        margin-bottom: 8px;
        font-size: 36px;
        color: var(--dark-gray);
    }
    
    .document-info {
        font-size: 11px;
        text-align: left;
    }
    
    .document-filename {
        color: var(--cyan);
        font-weight: bold;
        margin-bottom: 3px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .document-date {
        color: var(--gray);
        font-size: 10px;
    }
    
    .status-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
    }
    
    .status-completed { 
        background: rgba(0, 255, 0, 0.2); 
        color: var(--green); 
    }
    .status-pending { 
        background: rgba(255, 255, 0, 0.2); 
        color: var(--yellow); 
    }
    .status-processing { 
        background: rgba(0, 255, 255, 0.2); 
        color: var(--cyan); 
    }
    .status-failed { 
        background: rgba(255, 0, 0, 0.2); 
        color: #ff6666; 
    }
    .status-manual_review { 
        background: rgba(255, 140, 0, 0.2); 
        color: var(--orange); 
    }
    
    .ocr-indicator {
        position: absolute;
        bottom: 5px;
        left: 5px;
        font-size: 16px;
    }
    
    .has-ocr { color: var(--green); }
    .no-ocr { color: var(--dark-gray); }
    
    /* Page size selector */
    .page-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 15px 0;
        padding: 10px;
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
    }
    
    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .page-size-label {
        color: var(--gray);
        font-size: 12px;
        text-transform: lowercase;
    }
    
    .page-size-select {
        background: #000;
        color: var(--cyan);
        border: 1px solid var(--dark-gray);
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .page-link {
        padding: 6px 10px;
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        color: var(--cyan);
        text-decoration: none;
        border-radius: 3px;
        transition: all 0.3s;
        font-size: 12px;
    }
    
    .page-link:hover {
        border-color: var(--orange);
        color: var(--orange);
    }
    
    .page-link.active {
        background: var(--orange);
        color: #000;
        border-color: var(--orange);
        font-weight: bold;
    }
    
    .page-link.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        color: var(--gray);
    }
</style>

<div class="content-box" style="position: relative;">
    <h1 class="content-title">üìÑ documents & ocr integration</h1>
    
    <!-- Quick Action Bar -->
    <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 10px;">
        <a href="{% url 'documents:upload' %}" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
            üì§ Upload
        </a>
        <button onclick="runAIAnalysis()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(45deg, #FF8C00, #FFA500); border: none;">
            ü§ñ AI Scan All
        </button>
        <a href="{% url 'documents:recycle_bin' %}" class="recycle-bin-link" style="position: static;">
            üóëÔ∏è Recycle Bin
            {% if deleted_count > 0 %}
                <span class="count">{{ deleted_count }}</span>
            {% endif %}
        </a>
    </div>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_documents }}</div>
            <div class="stat-label">total documents</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ processed_documents }}</div>
            <div class="stat-label">processed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ pending_documents }}</div>
            <div class="stat-label">pending ocr</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">‚Ç∫{{ monthly_subscriptions_total|floatformat:0 }}</div>
            <div class="stat-label">monthly subscriptions</div>
        </div>
    </div>
</div>

<!-- Page Controls -->
<div class="content-box">
    <div class="page-controls">
        <div class="page-size-selector">
            <span class="page-size-label">items per page:</span>
            <select class="page-size-select" id="pageSizeSelect" onchange="changePageSize(this.value)">
                <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
            </select>
        </div>
        <div style="color: var(--gray); font-size: 12px;">
            showing {{ documents.start_index }}-{{ documents.end_index }} of {{ paginator.count }}
        </div>
    </div>
</div>

<!-- Documents Grid with Thumbnails -->
<div class="content-box">
    <h2 class="content-title">üìã documents ({{ paginator.count }} total)</h2>
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActions">
        <span class="selection-info">
            <span id="selectedCount">0</span> selected
        </span>
        <button class="btn btn-secondary" onclick="selectAll()">select all</button>
        <button class="btn btn-secondary" onclick="selectNone()">select none</button>
        <button class="btn btn-secondary" onclick="selectInverse()">invert selection</button>
        <button class="btn" onclick="bulkDelete()" style="background: var(--red); color: white;">üóëÔ∏è delete selected</button>
        <button class="btn" onclick="bulkExport()">üì§ export selected</button>
        <button class="btn" onclick="bulkReprocess()">üîÑ reprocess ocr</button>
    </div>
    
    <!-- Selection Controls with Better Visibility -->
    <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-dark); border: 1px solid var(--dark-gray); border-radius: 5px;">
        <label style="color: var(--orange); font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="enableSelection" onchange="toggleSelectionMode()" style="width: 18px; height: 18px;"> 
            <span>üìå Enable Multi-Select Mode</span>
            <span style="color: var(--gray); font-size: 11px; margin-left: 10px;">(select multiple documents for bulk operations)</span>
        </label>
    </div>
    
    {% if documents %}
    <div class="document-grid">
        {% for doc in documents %}
        <div class="document-card" 
             data-doc-id="{{ doc.id }}"
             onclick="handleCardClick(event, '{{ doc.id }}', '{% url 'documents:document_detail' doc.id %}')"
             style="cursor: pointer; position: relative;">
            <!-- Selection Checkbox -->
            <input type="checkbox" 
                   class="document-checkbox" 
                   data-doc-id="{{ doc.id }}"
                   onclick="event.stopPropagation(); updateSelection()"
                   style="display: none;">
            <!-- Status Badge -->
            <span class="status-badge status-{{ doc.processing_status }}">
                {% if doc.processing_status == 'completed' %}‚úì
                {% elif doc.processing_status == 'pending' %}‚è≥
                {% elif doc.processing_status == 'processing' %}‚öôÔ∏è
                {% elif doc.processing_status == 'failed' %}‚úó
                {% else %}üëÅÔ∏è{% endif %}
            </span>
            
            <!-- OCR Indicator -->
            <span class="ocr-indicator {% if doc.ocr_text %}has-ocr{% else %}no-ocr{% endif %}">
                {% if doc.ocr_text %}üìù{% else %}üìÑ{% endif %}
            </span>
            
            <!-- Original Document Image -->
            {% if doc.file_path %}
                <img src="{{ doc.file_path.url }}" class="document-thumbnail" alt="{{ doc.original_filename }}">
            {% else %}
                <div class="document-placeholder">
                    {% if doc.document_type == 'receipt' %}üßæ
                    {% elif doc.document_type == 'invoice' %}üìë
                    {% elif doc.document_type == 'bank_statement' %}üè¶
                    {% elif doc.document_type == 'cc_statement' %}üí≥
                    {% else %}üìÑ{% endif %}
                </div>
            {% endif %}
            
            <!-- Document Info -->
            <div class="document-info">
                <div class="document-filename" title="{{ doc.original_filename }}">
                    {{ doc.original_filename|truncatechars:20 }}
                </div>
                <div class="document-date">
                    {{ doc.uploaded_at|date:"d M H:i" }}
                </div>
                {% if doc.ocr_text %}
                <div style="color: var(--green); font-size: 10px;">
                    {{ doc.ocr_text|length }} chars
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if paginator.num_pages > 1 %}
    <div class="pagination">
        {% if documents.has_previous %}
        <a href="?page=1&page_size={{ page_size }}{% if doc_type %}&type={{ doc_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
           class="page-link">¬´ first</a>
        <a href="?page={{ documents.previous_page_number }}&page_size={{ page_size }}{% if doc_type %}&type={{ doc_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
           class="page-link">‚Äπ prev</a>
        {% else %}
        <span class="page-link disabled">¬´ first</span>
        <span class="page-link disabled">‚Äπ prev</span>
        {% endif %}
        
        <span style="color: var(--gray); font-size: 12px; margin: 0 10px;">
            page {{ documents.number }} of {{ paginator.num_pages }}
        </span>
        
        {% if documents.has_next %}
        <a href="?page={{ documents.next_page_number }}&page_size={{ page_size }}{% if doc_type %}&type={{ doc_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
           class="page-link">next ‚Ä∫</a>
        <a href="?page={{ paginator.num_pages }}&page_size={{ page_size }}{% if doc_type %}&type={{ doc_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
           class="page-link">last ¬ª</a>
        {% else %}
        <span class="page-link disabled">next ‚Ä∫</span>
        <span class="page-link disabled">last ¬ª</span>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div style="text-align: center; padding: 40px; color: var(--gray);">
        <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
        <div>no documents uploaded yet</div>
        <button class="btn" onclick="window.location.href='{% url 'documents:upload' %}'" style="margin-top: 20px;">
            üì§ upload documents
        </button>
    </div>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="content-box">
    <h2 class="content-title">‚ö° quick actions</h2>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="window.location.href='{% url 'documents:upload' %}'">
            üì§ batch upload
        </button>
        <button class="btn" onclick="window.location.href='{% url 'documents:document_list' %}'">
            üìö full list view
        </button>
        <button class="btn btn-secondary" onclick="processAllPending()">
            üîÑ process pending
        </button>
        <button class="btn btn-secondary" onclick="regenerateAllThumbnails()">
            üñºÔ∏è regenerate thumbs
        </button>
    </div>
</div>

<!-- Gamification Actions -->
<div class="content-box">
    <h2 class="content-title">üéÆ gamification & rewards</h2>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="window.location.href='{% url 'documents:receipt_hub' %}'" style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000;">
            üéØ receipt game hub
        </button>
        <button class="btn" onclick="window.location.href='{% url 'documents:leaderboard' %}'" style="background: linear-gradient(45deg, #00CED1, #4169E1); color: #fff;">
            üèÜ leaderboard
        </button>
        <button class="btn" onclick="window.location.href='{% url 'documents:achievements' %}'" style="background: linear-gradient(45deg, #9370DB, #FF69B4); color: #fff;">
            üèÖ achievements
        </button>
        <button class="btn" onclick="window.location.href='{% url 'documents:challenges' %}'" style="background: linear-gradient(45deg, #32CD32, #00FA9A); color: #000;">
            üéØ daily challenges
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='{% url 'documents:document_validation' %}'">
            üë• community validation
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='{% url 'documents:simple_receipt_hub' %}'">
            üßæ simple receipt test
        </button>
    </div>
    
    <!-- User Stats -->
    <div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; border-radius: 5px;">
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div>
                <div style="color: #FFD700; font-size: 24px; font-weight: bold;">{{ user_points|default:"0" }}</div>
                <div style="color: var(--gray); font-size: 11px;">your points</div>
            </div>
            <div>
                <div style="color: #00CED1; font-size: 24px; font-weight: bold;">{{ user_rank|default:"‚àû" }}</div>
                <div style="color: var(--gray); font-size: 11px;">global rank</div>
            </div>
            <div>
                <div style="color: #9370DB; font-size: 24px; font-weight: bold;">{{ user_achievements|default:"0" }}</div>
                <div style="color: var(--gray); font-size: 11px;">achievements</div>
            </div>
            <div>
                <div style="color: #32CD32; font-size: 24px; font-weight: bold;">{{ active_challenges|default:"0" }}</div>
                <div style="color: var(--gray); font-size: 11px;">active challenges</div>
            </div>
        </div>
    </div>
</div>


<script>
// Preserve scroll position
let scrollPosition = 0;

window.addEventListener('beforeunload', function() {
    scrollPosition = window.scrollY;
    sessionStorage.setItem('scrollPos', scrollPosition);
});

window.addEventListener('load', function() {
    const savedPos = sessionStorage.getItem('scrollPos');
    if (savedPos) {
        window.scrollTo(0, parseInt(savedPos));
        sessionStorage.removeItem('scrollPos');
    }
});

// AI Analysis Functions
function runAIAnalysis() {
    if (!confirm('Run AI analysis on all documents? This may take a few minutes.')) {
        return;
    }
    
    const progressDiv = document.createElement('div');
    progressDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid #FF8C00; padding: 20px; border-radius: 10px; z-index: 9999;';
    progressDiv.innerHTML = `
        <h3 style="color: #FF8C00; margin: 0 0 10px 0;">ü§ñ AI Analysis in Progress</h3>
        <div style="color: #00FFFF;">Processing documents...</div>
        <div id="ai-progress" style="color: #00FF00; margin-top: 10px;">0 / 0 documents</div>
        <div style="width: 300px; height: 20px; background: #333; margin-top: 10px; border-radius: 10px;">
            <div id="ai-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #FF8C00, #FFA500); border-radius: 10px; transition: width 0.3s;"></div>
        </div>
    `;
    document.body.appendChild(progressDiv);
    
    fetch("{% url 'documents:ai_batch_process' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            'all_documents': true
        })
    })
    .then(response => response.json())
    .then(data => {
        document.body.removeChild(progressDiv);
        
        if (data.success) {
            alert(`‚úÖ AI Analysis Complete!\n\nProcessed: ${data.processed} documents\nEnhanced: ${data.enhanced} documents\nFailed: ${data.failed} documents`);
            location.reload();
        } else {
            alert('‚ùå AI Analysis failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        document.body.removeChild(progressDiv);
        alert('‚ùå Error: ' + error);
    });
}

// Change page size
function changePageSize(size) {
    const url = new URL(window.location);
    url.searchParams.set('page_size', size);
    url.searchParams.set('page', '1'); // Reset to first page
    window.location.href = url.toString();
}

// Process all pending documents
function processAllPending() {
    if (confirm('Process OCR for all pending documents?')) {
        fetch('{% url "documents:api_batch_ocr" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'pending'
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(`Processing ${data.processing_count} documents...`);
            setTimeout(() => window.location.reload(), 2000);
        });
    }
}

// Regenerate all thumbnails
function regenerateAllThumbnails() {
    if (confirm('Regenerate thumbnails for all documents?')) {
        fetch('{% url "documents:api_batch_thumbnails" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                all: true,
                force: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully regenerated ${data.data.success} thumbnails!`);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error regenerating thumbnails: ' + error);
        });
    }
}

// Regenerate thumbnail for single document
function regenerateThumbnail(documentId) {
    fetch(`/documents/api/document/${documentId}/regenerate-thumbnail/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update thumbnail in UI
            const card = document.querySelector(`[data-doc-id="${documentId}"]`);
            if (card) {
                const thumbnail = card.querySelector('.document-thumbnail');
                if (thumbnail) {
                    thumbnail.src = data.data.thumbnail_url + '?t=' + Date.now();
                }
            }
            alert('Thumbnail regenerated successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    });
}
// Multi-select functionality
let selectionMode = false;
let selectedDocuments = new Set();

function toggleSelectionMode() {
    selectionMode = document.getElementById('enableSelection').checked;
    const checkboxes = document.querySelectorAll('.document-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const documentGrid = document.querySelector('.document-grid');
    
    if (selectionMode) {
        checkboxes.forEach(cb => cb.style.display = 'block');
        bulkActions.classList.add('show');
        if (documentGrid) documentGrid.classList.add('selection-mode');
    } else {
        checkboxes.forEach(cb => {
            cb.style.display = 'none';
            cb.checked = false;
        });
        bulkActions.classList.remove('show');
        if (documentGrid) documentGrid.classList.remove('selection-mode');
        selectedDocuments.clear();
        updateSelectionUI();
    }
}

function handleCardClick(event, docId, detailUrl) {
    if (!selectionMode) {
        window.location.href = detailUrl;
    } else {
        const checkbox = event.currentTarget.querySelector('.document-checkbox');
        checkbox.checked = !checkbox.checked;
        updateSelection();
    }
}

function updateSelection() {
    selectedDocuments.clear();
    const checkboxes = document.querySelectorAll('.document-checkbox:checked');
    
    checkboxes.forEach(cb => {
        const docId = cb.dataset.docId;
        selectedDocuments.add(docId);
        cb.closest('.document-card').classList.add('selected');
    });
    
    // Update unselected cards
    document.querySelectorAll('.document-checkbox:not(:checked)').forEach(cb => {
        cb.closest('.document-card').classList.remove('selected');
    });
    
    updateSelectionUI();
}

function updateSelectionUI() {
    document.getElementById('selectedCount').textContent = selectedDocuments.size;
}

function selectAll() {
    document.querySelectorAll('.document-checkbox').forEach(cb => {
        cb.checked = true;
    });
    updateSelection();
}

function selectNone() {
    document.querySelectorAll('.document-checkbox').forEach(cb => {
        cb.checked = false;
    });
    updateSelection();
}

function selectInverse() {
    document.querySelectorAll('.document-checkbox').forEach(cb => {
        cb.checked = !cb.checked;
    });
    updateSelection();
}

function bulkDelete() {
    if (selectedDocuments.size === 0) {
        alert('No documents selected');
        return;
    }
    
    if (confirm(`Move ${selectedDocuments.size} document(s) to recycle bin?`)) {
        const docIds = Array.from(selectedDocuments);
        
        fetch('{% url "documents:bulk_delete" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                document_ids: docIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.deleted_count} document(s) moved to recycle bin`);
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function bulkExport() {
    if (selectedDocuments.size === 0) {
        alert('No documents selected');
        return;
    }
    
    const docIds = Array.from(selectedDocuments);
    const params = new URLSearchParams();
    docIds.forEach(id => params.append('doc_id', id));
    
    window.open('{% url "documents:export" %}?' + params.toString(), '_blank');
}

function bulkReprocess() {
    if (selectedDocuments.size === 0) {
        alert('No documents selected');
        return;
    }
    
    if (confirm(`Reprocess OCR for ${selectedDocuments.size} document(s)?`)) {
        const docIds = Array.from(selectedDocuments);
        
        fetch('{% url "documents:bulk_reprocess" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                document_ids: docIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`OCR reprocessing started for ${data.queued_count} document(s)`);
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>

{% endblock %}