{% extends 'birlikteyiz/base_birlikteyiz.html' %}

{% block title %}birlikteyiz - unibos{% endblock %}

{% block birlikteyiz_content %}

<!-- Statistics Overview -->
<div class="section">
    <div class="section-header">
        <h2>istatistikler</h2>
        <div class="section-controls">
            <button class="btn-secondary" onclick="refreshData()">üîÑ yenile</button>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ recent_earthquakes|length }}</div>
            <div class="stat-label">son 7 g√ºn deprem</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ active_zones|length }}</div>
            <div class="stat-label">aktif afet b√∂lgesi</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ online_nodes }}/{{ total_nodes }}</div>
            <div class="stat-label">mesh aƒüƒ± d√ºƒü√ºmleri</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ recent_messages }}</div>
            <div class="stat-label">24 saat i√ßi mesaj</div>
        </div>
    </div>
</div>

<!-- Recent Earthquakes -->
<div class="section">
    <div class="section-header">
        <h2>son depremler</h2>
        <div class="section-controls">
            <a href="{% url 'birlikteyiz:earthquake_list' %}" class="btn-secondary">t√ºm√ºn√º g√∂ster ‚Üí</a>
        </div>
    </div>
    
    {% if recent_earthquakes %}
    <table class="data-table">
        <thead>
            <tr>
                <th>zaman</th>
                <th>b√ºy√ºkl√ºk</th>
                <th>derinlik</th>
                <th>lokasyon</th>
                <th>kaynak</th>
            </tr>
        </thead>
        <tbody>
            {% for eq in recent_earthquakes|slice:":10" %}
            <tr>
                <td>
                    {{ eq.occurred_at|date:"d.m.Y H:i" }}
                    <div style="font-size: 10px; color: var(--gray);">{{ eq.occurred_at|timesince }} √∂nce</div>
                </td>
                <td>
                    <span style="font-weight: bold; color: 
                        {% if eq.magnitude >= 5 %}#ff4444
                        {% elif eq.magnitude >= 4 %}var(--orange)
                        {% elif eq.magnitude >= 3 %}var(--yellow)
                        {% else %}var(--green){% endif %};">
                        {{ eq.magnitude }}
                    </span>
                </td>
                <td>{{ eq.depth }} km</td>
                <td title="{{ eq.location }}">
                    {{ eq.location|truncatechars:40 }}
                    {% if eq.city %}
                    <div style="font-size: 10px; color: var(--gray);">{{ eq.city }}</div>
                    {% endif %}
                </td>
                <td>
                    <span class="status-badge" style="background: rgba(0, 255, 255, 0.1); color: var(--cyan); border: 1px solid var(--cyan);">
                        {{ eq.source|lower }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üåç</div>
        <div class="empty-state-title">hen√ºz deprem verisi yok</div>
        <div class="empty-state-text">veriler 5 dakikada bir g√ºncellenir</div>
        <button class="btn-primary" onclick="startDataFetch()">≈üimdi veri √ßek</button>
    </div>
    {% endif %}
</div>

<!-- Data Sources Status -->
<div class="section">
    <div class="section-header">
        <h2>veri kaynaklarƒ± durumu</h2>
        <div class="section-controls">
            <a href="{% url 'birlikteyiz:cron_jobs' %}" class="btn-secondary">detaylar ‚Üí</a>
        </div>
    </div>
    
    <div class="stats-grid">
        {% for source in data_sources %}
        <div class="stat-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">{{ source.name|lower }}</div>
                    <div style="font-size: 10px; color: var(--gray);">{{ source.url|truncatechars:30 }}</div>
                </div>
                <span class="status-badge status-{% if source.is_active %}active{% else %}inactive{% endif %}">
                    {% if source.is_active %}aktif{% else %}pasif{% endif %}
                </span>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--dark-gray);">
                <div style="display: flex; justify-content: space-between; font-size: 11px;">
                    <span>toplam √ßekim:</span>
                    <span>{{ source.fetch_count }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 11px;">
                    <span>hata sayƒ±sƒ±:</span>
                    <span style="color: {% if source.error_count > 0 %}#ff4444{% else %}var(--green){% endif %};">
                        {{ source.error_count }}
                    </span>
                </div>
                {% if source.last_fetch %}
                <div style="display: flex; justify-content: space-between; font-size: 11px;">
                    <span>son √ßekim:</span>
                    <span>{{ source.last_fetch|timesince }} √∂nce</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Active Alerts -->
{% if active_zones %}
<div class="section">
    <div class="section-header">
        <h2>aktif uyarƒ±lar</h2>
    </div>
    
    {% for zone in active_zones %}
    <div class="alert alert-danger">
        <strong>{{ zone.name }}</strong> - Seviye: {{ zone.severity }}
        <div style="font-size: 11px; margin-top: 5px;">
            {{ zone.declared_at|timesince }} √∂nce ilan edildi
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
function refreshData() {
    location.reload();
}

function startDataFetch() {
    if (confirm('T√ºm kaynaklardan veri √ßekmek istiyor musunuz?')) {
        fetch('{% url "birlikteyiz:manual_fetch" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Veri √ßekme i≈ülemi ba≈ülatƒ±ldƒ±');
                setTimeout(() => location.reload(), 2000);
            } else {
                alert('Hata: ' + data.error);
            }
        });
    }
}
</script>

{% endblock %}